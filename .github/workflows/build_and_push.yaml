name: Build and push Docker image to dockerhub
on:
  workflow_dispatch:
  schedule:
    - cron:  '30 4 * * *'
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Login to dockerhub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Get current version
      id: version
      run: echo "CURRENT_VERSION=$(grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' .github/workflows/build_and_push.yaml | head -n1)" >> $GITHUB_OUTPUT
    - name: Build and push to dockerhub
      uses: docker/build-push-action@v6
      with:
       context: .
       push: true
       tags: broome/genetics-tools:${{ steps.version.outputs.CURRENT_VERSION }}
    - name: Increment version and push to repo
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        CURRENT_VERSION=${{ steps.version.outputs.CURRENT_VERSION }}
        echo "Current version: $CURRENT_VERSION"

        # Strip 'v' prefix and split into components
        VERSION_STRING=$(echo $CURRENT_VERSION | sed 's/v//')
        MAJOR=$(echo $VERSION_STRING | cut -d. -f1)
        MINOR=$(echo $VERSION_STRING | cut -d. -f2)
        PATCH=$(echo $VERSION_STRING | cut -d. -f3)

        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
        echo "New version: $NEW_VERSION"

        # Replace version in files
        sed -i "s/${CURRENT_VERSION}/${NEW_VERSION}/g" Dockerfile
        sed -i "s/${CURRENT_VERSION}/${NEW_VERSION}/g" .github/workflows/build_and_push.yaml

        # Commit and push changes
        git add Dockerfile .github/workflows/build_and_push.yaml
        if git diff --staged --quiet; then
          echo "Version already up to date."
        else
          git commit -m "Bump version to ${NEW_VERSION}"
          git push
        fi
